<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Story ¬∑ Vaahaka</title>
  <link rel="stylesheet" href="/ayshu/assets/app.css?v=8">
  <style>
    .wrap-narrow{max-width:900px;margin:0 auto;padding:0 14px}
    .topbar{display:flex;justify-content:space-between;align-items:center;gap:10px;margin:14px 0}
    .title{margin:6px 0 2px}
    .meta{color:var(--muted);margin-bottom:10px}

    /* parts chips */
    #parts{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 16px}
    .chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:13px}
    .chip.active{background:#fff5ea;border-color:#ffd9a8}

    /* reader */
    .reader{background:#fff;border:1px solid var(--border);border-radius:20px;box-shadow:0 30px 80px rgba(20,12,0,.08);padding:18px}
    .story-body{font-size:1.06rem;line-height:1.85}
    .story-body p{margin:0 0 1.05em}
    .story-body p + p{text-indent:1.05em}

    /* controls */
    .controls{display:flex;gap:8px;align-items:center}
    .fsbtn{min-width:36px;height:32px}
    .reacts{display:flex;gap:8px;align-items:center}
    .reacts button{display:inline-flex;gap:6px;align-items:center}
    .reacts .pill{box-shadow:0 2px 10px rgba(255,102,0,.15)}

    /* prev/next */
    .pager{display:flex;justify-content:space-between;margin-top:16px}

    /* anti-copy: only the reading zone */
    .nocopy{-webkit-user-select:none;user-select:none}
    .watermark{pointer-events:none; position:fixed; inset:auto 0 8px 0; text-align:center; font-size:11px; color:rgba(0,0,0,.25)}

    @media (min-width: 800px){ .story-body{font-size:1.12rem} }
  </style>
</head>
<body>

<header class="nav">
  <div class="wrap bar" style="justify-content:space-between;">
    <a href="/ayshu/" class="brand">Vaahaka</a>
    <nav class="bar">
      <a href="/ayshu/explore.html">Explore</a>
      <a href="/ayshu/write.html">Write</a>
      <a href="/ayshu/about.html">About</a>
      <a href="/ayshu/mypanel.html">My Panel</a>
    </nav>
  </div>
</header>
<div id="toast" class="toast"></div>

<div class="wrap-narrow">
  <div class="topbar">
    <button id="btnClose" class="ghost">‚úï Close</button>
    <div class="controls">
      <div class="reacts">
        <button id="btnLike" class="ghost" title="Like">üëç <span id="likeCnt">0</span></button>
        <button id="btnLove" class="" title="Love">‚ù§Ô∏è <span id="loveCnt">0</span></button>
      </div>
      <span class="muted" style="font-size:12px;margin-left:8px">Font</span>
      <button id="fsDec" class="ghost fsbtn" aria-label="Smaller">A‚àí</button>
      <button id="fsInc" class="fsbtn" aria-label="Bigger">A+</button>
    </div>
  </div>

  <h1 id="title" class="title"></h1>
  <div id="meta" class="meta"></div>

  <!-- Series parts chips -->
  <div id="parts"></div>

  <div class="reader">
    <div id="body" class="story-body nocopy"></div>
    <div id="nav" class="pager"></div>
  </div>

  <div id="wm" class="watermark" style="display:none"></div>
</div>

<script type="module">
  import {
    auth, getStory, getSinglePost,
    listSeriesPartsOrdered, getAdjacentParts, bumpHot,
    getMyReaction, setReaction, getReactionsSummary
  } from "/ayshu/assets/firebase.js?v=117";

  // ---- helpers
  const Q = new URLSearchParams(location.search);
  const storyId = Q.get('id');
  const partParam = Number(Q.get('part') || 0) || null;

  const $ = (id)=>document.getElementById(id);
  const titleEl = $('title'), metaEl=$('meta'), bodyEl=$('body'), partsEl=$('parts'), navEl=$('nav');
  const btnClose = $('btnClose'), fsDec=$('fsDec'), fsInc=$('fsInc'), wm=$('wm');
  const btnLike = $('btnLike'), btnLove = $('btnLove'), likeCnt = $('likeCnt'), loveCnt = $('loveCnt');

  const esc = (s)=> (s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const paras = (text)=> (text||'').split(/\n{2,}/).map(p=>`<p>${esc(p).replace(/\n/g,' ')}</p>`).join('');
  const linkTo = (sid, pn)=> `/ayshu/story.html?id=${encodeURIComponent(sid)}${pn?`&part=${pn}`:''}`;

  // Close always ‚Üí Explore (avoids back-through-parts loop)
  btnClose.onclick = ()=>{ location.href = '/ayshu/explore.html'; };

  // Font size controls (persist per-session)
  const FS_KEY = 'vaahaka_reader_fs';
  function setFs(pct){
    const clamp = Math.max(80, Math.min(160, pct|0));
    bodyEl.style.fontSize = clamp + '%';
    sessionStorage.setItem(FS_KEY, String(clamp));
  }
  fsDec.onclick = ()=> setFs((+sessionStorage.getItem(FS_KEY) || 106) - 8);
  fsInc.onclick = ()=> setFs((+sessionStorage.getItem(FS_KEY) || 106) + 8);
  setFs(+sessionStorage.getItem(FS_KEY) || 106);

  // Anti-copy (can‚Äôt block screenshots, but this deters quick copying)
  function attachNoCopy(el){
    const stop = (e)=>{ e.preventDefault(); e.stopPropagation(); return false; };
    el.addEventListener('copy', stop);
    el.addEventListener('cut', stop);
    el.addEventListener('contextmenu', stop);
    el.addEventListener('dragstart', stop);
  }
  attachNoCopy(bodyEl);

  // Optional watermark (only if logged in)
  function showWatermark(){
    const u = auth.currentUser;
    if (!u) { wm.style.display = 'none'; return; }
    const ts = new Date().toLocaleString();
    wm.textContent = `Read by ${u.email || 'user'} ¬∑ ${ts} ¬∑ Vaahaka`;
    wm.style.display = 'block';
  }
  window.addEventListener('firebase-auth-changed', showWatermark);

  // --- Reactions
  async function refreshReactions(){
    try{
      const { like, love } = await getReactionsSummary(storyId);
      likeCnt.textContent = like;
      loveCnt.textContent = love;

      const uid = auth.currentUser?.uid || null;
      const my = await getMyReaction(storyId, uid);
      btnLike.classList.toggle('pill', !!my.like);
      btnLove.classList.toggle('pill', !!my.love);
    }catch{}
  }
  async function toggleReaction(kind){
    const u = auth.currentUser;
    if (!u){ alert('Log in to react'); return; }
    try{
      const my = await getMyReaction(storyId, u.uid);
      await setReaction(storyId, u.uid, kind, !my[kind]);
      refreshReactions();
    }catch(e){ console.error(e); }
  }
  btnLike?.addEventListener('click', ()=> toggleReaction('like'));
  btnLove?.addEventListener('click', ()=> toggleReaction('love'));
  window.addEventListener('firebase-auth-changed', refreshReactions);

  // --- Main load
  async function load(){
    const s = await getStory(storyId).catch(()=>null);
    if (!s){ titleEl.textContent='Not found'; metaEl.textContent=''; bodyEl.innerHTML=''; partsEl.innerHTML=''; navEl.innerHTML=''; return; }

    titleEl.textContent = s.title || '(untitled)';
    metaEl.textContent  = `${(s.language||'').toUpperCase()} ¬∑ ${s.type} ¬∑ ${Array.isArray(s.genres)?s.genres.join(', '):''}`;

    if (s.type === 'single'){
      const post = await getSinglePost(storyId).catch(()=>null);
      bodyEl.innerHTML = paras(post?.body || '');
      partsEl.innerHTML = '';
      navEl.innerHTML = '';
    } else {
      // SERIES: list parts & render current
      const parts = await listSeriesPartsOrdered(storyId).catch(()=>[]);
      if (!parts.length){ bodyEl.innerHTML = '<p class="muted">No parts yet.</p>'; partsEl.innerHTML=''; navEl.innerHTML=''; return; }

      const firstPn = Number(parts[0].partNumber || 1);
      const currentPn = partParam || firstPn;

      // chips
      partsEl.innerHTML = parts.map(p=>{
        const active = Number(p.partNumber||0) === currentPn;
        const label  = esc(p.title || `Part ${p.partNumber}`);
        return `<a class="chip ${active?'active':''}" href="${linkTo(storyId, p.partNumber)}">${label}</a>`;
      }).join('');

      // body of current
      const current = parts.find(p=> Number(p.partNumber||0) === currentPn) || parts[0];
      bodyEl.innerHTML = paras(current?.body || '');

      // prev / next
      const { prev, next } = await getAdjacentParts(storyId, current.partNumber).catch(()=>({}));
      navEl.innerHTML = `
        ${prev ? `<a class="ghost" href="${linkTo(storyId, prev.partNumber)}">‚Üê Previous</a>` : '<span></span>'}
        ${next ? `<a class="pill"  href="${linkTo(storyId, next.partNumber)}">Next ‚Üí</a>` : '<span class="muted">End of series</span>'}
      `;
    }

    try{ await bumpHot(storyId, 1); }catch{}
    showWatermark();
    refreshReactions();
  }

  load();
</script>
</body>
</html>
