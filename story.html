<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Story · Vaahaka</title>
<link rel="stylesheet" href="/ayshu/assets/app.css?v=5">
</head>
<body>

<header class="nav">
  <div class="wrap bar" style="justify-content:space-between;">
    <a href="/ayshu/" class="brand">Vaahaka</a>
    <nav class="bar">
      <a href="/ayshu/explore.html">Explore</a>
      <a href="/ayshu/write.html">Write</a>
      <a href="/ayshu/about.html">About</a>
      <a href="/ayshu/mypanel.html">My Panel</a>
    </nav>
  </div>
</header>
<div id="toast" class="toast"></div>

<div class="wrap">
  <div class="backbar">
    <button id="btnBack" class="ghost">← Back</button>
    <span class="muted">Explore More</span>
  </div>
</div>

<div class="reader-wrap">
  <div class="reader-card">
    <h2 id="title" class="reader-title"></h2>
    <div id="meta" class="reader-meta"></div>

    <div class="reader-controls">
      <div class="group">
        <span class="muted">Font</span>
        <button id="fsDec" class="ghost">A−</button>
        <span id="fsVal" class="fs-display">100%</span>
        <button id="fsInc">A+</button>
      </div>
      <div class="group" id="seriesNavTop" style="display:none">
        <button id="prevPart" class="ghost">← Previous</button>
        <button id="nextPart">Next →</button>
      </div>
    </div>

    <div id="body" class="reader-body"></div>

    <div class="nav-parts" id="partsList" style="display:none"></div>

    <div class="reader-controls" id="seriesNavBottom" style="display:none">
      <div class="group"></div>
      <div class="group">
        <button id="prevPart2" class="ghost">← Previous</button>
        <button id="nextPart2">Next →</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { getStory, getSinglePost, listSeriesParts, bumpHot } from "/ayshu/assets/firebase.js?v=105";

  const $ = (id)=>document.getElementById(id);
  const q = new URLSearchParams(location.search);
  const storyId = q.get('id');
  const partFromUrl = parseInt(q.get('part') || '1', 10);

  const titleEl = $('title');
  const metaEl  = $('meta');
  const bodyEl  = $('body');
  const partsList = $('partsList');
  const navTop = $('seriesNavTop');
  const navBottom = $('seriesNavBottom');
  const prevTop = $('prevPart'), nextTop = $('nextPart');
  const prevBottom = $('prevPart2'), nextBottom = $('nextPart2');

  // Back button (with fallback to Explore)
  $('btnBack').onclick = () => {
    if (document.referrer && new URL(document.referrer).origin === location.origin) {
      history.back();
    } else {
      location.href = "/ayshu/explore.html";
    }
  };

  // Font size control (persisted)
  const FS_KEY = "vaahaka.fs";
  const fsVal = $('fsVal'), fsInc = $('fsInc'), fsDec = $('fsDec');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function applyFs(percent){
    fsVal.textContent = percent + "%";
    bodyEl.style.fontSize = (percent/100) + "rem";
    localStorage.setItem(FS_KEY, String(percent));
  }
  let fs = parseInt(localStorage.getItem(FS_KEY)||"100",10); if (isNaN(fs)) fs=100;
  applyFs(clamp(fs,80,160));
  fsInc.onclick = ()=>{ fs = clamp(fs+10, 80,160); applyFs(fs); };
  fsDec.onclick = ()=>{ fs = clamp(fs-10, 80,160); applyFs(fs); };

  // Render helpers
  function renderParagraphs(text){
    if (!text) return "<p class='muted'>No content.</p>";
    const safe = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return safe.split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,' ')}</p>`).join("");
  }

  function updateSeriesNav(parts, idx){
    const count = parts.length;
    const hasPrev = idx > 0;
    const hasNext = idx < count-1;

    navTop.style.display = navBottom.style.display = (count>1) ? 'flex' : 'none';
    prevTop.style.display = prevBottom.style.display = hasPrev ? 'inline-block' : 'none';
    nextTop.style.display = nextBottom.style.display = hasNext ? 'inline-block' : 'none';

    const go = (i)=>{
      const part = parts[i];
      const url = new URL(location.href);
      url.searchParams.set('part', String(part.partNumber|| (i+1)));
      history.replaceState({}, "", url.toString());
      drawSeries(parts, i);
    };
    prevTop.onclick = prevBottom.onclick = ()=> hasPrev && go(idx-1);
    nextTop.onclick = nextBottom.onclick = ()=> hasNext && go(idx+1);
  }

  function drawSeries(parts, idx){
    const p = parts[idx];
    bodyEl.innerHTML = `<h3 style="margin:0 0 10px">${p.title || ('Part '+ (p.partNumber||idx+1))}</h3>` + renderParagraphs(p.body||"");
    partsList.style.display = 'flex';
    partsList.innerHTML = parts.map((x,i)=>`<button class="pill ${i===idx?'part-active':''}" data-i="${i}">${x.partNumber || (i+1)}</button>`).join("");
    partsList.onclick = (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const i = parseInt(btn.dataset.i,10); drawSeries(parts, i); updateSeriesNav(parts, i);
      const url = new URL(location.href); url.searchParams.set('part', String(parts[i].partNumber|| (i+1))); history.replaceState({}, "", url.toString());
    };
    updateSeriesNav(parts, idx);
  }

  async function load(){
    if (!storyId){ $('title').textContent="Story not found"; bodyEl.innerHTML="<p class='muted'>Story not found.</p>"; return; }
    const s = await getStory(storyId);
    if (!s){ $('title').textContent="Story not found"; bodyEl.innerHTML="<p class='muted'>Story not found.</p>"; return; }
    document.title = (s.title||"Story") + " · Vaahaka";
    $('title').textContent = s.title || "(untitled)";
    $('meta').textContent = `${(s.language||'').toUpperCase()} · ${s.type} · ${Array.isArray(s.genres)?s.genres.join(', '):''}`;

    if (s.type === "single"){
      const post = await getSinglePost(storyId);
      bodyEl.innerHTML = renderParagraphs(post?.body||"");
      navTop.style.display = navBottom.style.display = 'none';
      partsList.style.display = 'none';
    } else {
      const parts = await listSeriesParts(storyId);
      if (!parts.length){ bodyEl.innerHTML = "<p class='muted'>No parts yet.</p>"; return; }
      let idx = parts.findIndex(p=> (p.partNumber||0) === partFromUrl);
      if (idx === -1) idx = 0;
      drawSeries(parts, idx);
    }

    try{ await bumpHot(storyId, 1); }catch{}
  }
  load();
</script>
</body></html>
