<script type="module">
  import { auth, getRole, getStory, getSinglePost, listSeriesParts, bumpHot } from "/ayshu/assets/firebase.js?v=110";

  const $ = (id)=>document.getElementById(id);
  const q = new URLSearchParams(location.search);
  const storyId = q.get('id');
  const partFromUrl = parseInt(q.get('part') || '1', 10);

  const titleEl = $('title');
  const metaEl  = $('meta');
  const bodyEl  = $('body');
  const partsList = $('partsList');
  const navTop = $('seriesNavTop');
  const navBottom = $('seriesNavBottom');
  const prevTop = $('prevPart'), nextTop = $('nextPart');
  const prevBottom = $('prevPart2'), nextBottom = $('nextPart2');

  $('btnBack').onclick = () => {
    if (document.referrer && new URL(document.referrer).origin === location.origin) {
      history.back();
    } else {
      location.href = "/ayshu/explore.html";
    }
  };

  // Font size controls (same as before)
  const FS_KEY = "vaahaka.fs";
  const fsVal = $('fsVal'), fsInc = $('fsInc'), fsDec = $('fsDec');
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  function applyFs(percent){
    fsVal.textContent = percent + "%";
    bodyEl.style.fontSize = (percent/100) + "rem";
    localStorage.setItem(FS_KEY, String(percent));
  }
  let fs = parseInt(localStorage.getItem(FS_KEY)||"100",10); if (isNaN(fs)) fs=100;
  applyFs(clamp(fs,80,160));
  fsInc.onclick = ()=>{ fs = clamp(fs+10, 80,160); applyFs(fs); };
  fsDec.onclick = ()=>{ fs = clamp(fs-10, 80,160); applyFs(fs); };

  function renderParagraphs(text){
    if (!text) return "<p class='muted'>No content.</p>";
    const safe = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return safe.split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,' ')}</p>`).join("");
  }

  function updateSeriesNav(parts, idx){
    const count = parts.length;
    const hasPrev = idx > 0;
    const hasNext = idx < count-1;

    navTop.style.display = navBottom.style.display = (count>1) ? 'flex' : 'none';
    prevTop.style.display = prevBottom.style.display = hasPrev ? 'inline-block' : 'none';
    nextTop.style.display = nextBottom.style.display = hasNext ? 'inline-block' : 'none';

    const go = (i)=>{
      const part = parts[i];
      const url = new URL(location.href);
      url.searchParams.set('part', String(part.partNumber || (i+1)));
      history.replaceState({}, "", url.toString());
      drawSeries(parts, i);
    };
    prevTop.onclick = prevBottom.onclick = ()=> hasPrev && go(idx-1);
    nextTop.onclick = nextBottom.onclick = ()=> hasNext && go(idx+1);
  }

  function drawSeries(parts, idx){
    const p = parts[idx];
    bodyEl.innerHTML = `<h3 style="margin:0 0 10px">${p.title || ('Part '+ (p.partNumber||idx+1))}</h3>` + renderParagraphs(p.body||"");
    partsList.style.display = 'flex';
    partsList.innerHTML = parts.map((x,i)=>`<button class="pill ${i===idx?'part-active':''}" data-i="${i}">${x.partNumber || (i+1)}</button>`).join("");
    partsList.onclick = (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const i = parseInt(btn.dataset.i,10); drawSeries(parts, i); updateSeriesNav(parts, i);
      const url = new URL(location.href); url.searchParams.set('part', String(parts[i].partNumber|| (i+1))); history.replaceState({}, "", url.toString());
    };
    updateSeriesNav(parts, idx);
  }

  async function isOwnerOrAuthor(s){
    const u = auth.currentUser;
    if (!u) return false;
    const email = (u.email || "").toLowerCase();
    if (email === "nmmc@live.com" || email === "ayshuaysh@gmail.com") return true;
    if (s?.authorId && s.authorId === u.uid) return true;
    try { return (await getRole(u.uid)) === "owner"; } catch { return false; }
  }

  function showPreviewBanner(){
    const wrap = document.querySelector('.reader-card');
    const div = document.createElement('div');
    div.className = 'card';
    div.style.marginBottom = '12px';
    div.style.background = '#fff7ef';
    div.style.borderColor = '#ffd9ba';
    div.innerHTML = '<b>Preview:</b> this story is not published yet. Only owners and the author can see this.';
    wrap.parentNode.insertBefore(div, wrap);
  }

  async function load(){
    if (!storyId){
      $('title').textContent="Story not found";
      bodyEl.innerHTML="<p class='muted'>Story not found.</p>";
      return;
    }

    // Get metadata
    let s;
    try { s = await getStory(storyId); }
    catch (e) {
      // If rules block metadata for public while unpublished, we’ll still handle below
      s = null;
    }

    // If not published, only owners/authors should proceed
    if (!s || s.status !== "published"){
      const allowed = s ? await isOwnerOrAuthor(s) : await isOwnerOrAuthor(null);
      if (!allowed){
        document.title = "Unavailable · Vaahaka";
        $('title').textContent = "Unavailable";
        $('meta').textContent = "";
        bodyEl.innerHTML = "<p class='muted'>This story isn’t published yet.</p>";
        navTop.style.display = navBottom.style.display = 'none';
        partsList.style.display = 'none';
        return;
      } else {
        showPreviewBanner();
      }
    }

    // Render header/meta
    const meta = s || {};
    document.title = (meta.title||"Story") + " · Vaahaka";
    $('title').textContent = meta.title || "(untitled)";
    $('meta').textContent = `${(meta.language||'').toUpperCase()} · ${meta.type||''} · ${Array.isArray(meta.genres)?meta.genres.join(', '):''}`;

    // Body
    if ((s?.type || meta.type) === "single"){
      const post = await getSinglePost(storyId);
      bodyEl.innerHTML = renderParagraphs(post?.body||"");
      navTop.style.display = navBottom.style.display = 'none';
      partsList.style.display = 'none';
    } else {
      const parts = await listSeriesParts(storyId);
      if (!parts.length){ bodyEl.innerHTML = "<p class='muted'>No parts yet.</p>"; return; }
      let idx = parts.findIndex(p=> (p.partNumber||0) === partFromUrl);
      if (idx === -1) idx = 0;
      drawSeries(parts, idx);
    }

    try { await bumpHot(storyId, 1); } catch {}
  }

  window.addEventListener('firebase-auth-changed', load);
  load();
</script>
