<!doctype html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Story · Vaahaka</title>
<link rel="stylesheet" href="/ayshu/assets/app.css?v=5">
</head>
<body>

<header class="nav">
  <div class="wrap bar" style="justify-content:space-between;">
    <a href="/ayshu/" class="brand">Vaahaka</a>
    <nav class="bar">
      <a href="/ayshu/explore.html">Explore</a>
      <a href="/ayshu/write.html">Write</a>
      <a href="/ayshu/about.html">About</a>
      <a href="/ayshu/mypanel.html">My Panel</a>
    </nav>
  </div>
</header>
<div id="toast" class="toast"></div>

<div class="wrap">
  <div class="backbar">
    <button id="btnBack" class="ghost">← Back</button>
    <span class="muted">Explore More</span>
  </div>
</div>
<h1 id="title"></h1>
<div id="meta" class="muted"></div>

<!-- Show for series -->
<div id="parts" class="bar" style="flex-wrap:wrap; gap:8px; margin:10px 0"></div>

<div id="body" class="story"></div>

<!-- Prev / Next -->
<div id="nav"></div>

<div class="reader-wrap">
  <div class="reader-card">
    <h2 id="title" class="reader-title"></h2>
    <div id="meta" class="reader-meta"></div>

    <div class="reader-controls">
      <div class="group">
        <span class="muted">Font</span>
        <button id="fsDec" class="ghost">A−</button>
        <span id="fsVal" class="fs-display">100%</span>
        <button id="fsInc">A+</button>
      </div>
      <div class="group" id="seriesNavTop" style="display:none">
        <button id="prevPart" class="ghost">← Previous</button>
        <button id="nextPart">Next →</button>
      </div>
    </div>

    <div id="body" class="reader-body"></div>

    <div class="nav-parts" id="partsList" style="display:none"></div>

    <div class="reader-controls" id="seriesNavBottom" style="display:none">
      <div class="group"></div>
      <div class="group">
        <button id="prevPart2" class="ghost">← Previous</button>
        <button id="nextPart2">Next →</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import {
    auth, getStory, getSinglePost,
    listSeriesPartsOrdered, getAdjacentParts, bumpHot
  } from "/ayshu/assets/firebase.js?v=115";

  const Q = new URLSearchParams(location.search);
  const id = Q.get('id');
  const partParam = Number(Q.get('part')||0) || null;

  const titleEl = document.getElementById('title');
  const metaEl  = document.getElementById('meta');
  const bodyEl  = document.getElementById('body');
  const partsEl = document.getElementById('parts');      // <div id="parts"></div> in your layout (add if missing)
  const navEl   = document.getElementById('nav');        // <div id="nav"></div>   in your layout (add if missing)

  function esc(s){ return (s||'').replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
  function paras(text){ return (text||'').split(/\n{2,}/).map(p=>`<p>${esc(p).replace(/\n/g,' ')}</p>`).join(''); }
  function linkTo(storyId, pn){ return `/ayshu/story.html?id=${encodeURIComponent(storyId)}${pn?`&part=${pn}`:''}`; }

  async function load(){
    const s = await getStory(id).catch(()=>null);
    if (!s){ titleEl.textContent = 'Not found'; bodyEl.innerHTML = ''; return; }

    titleEl.textContent = s.title || '(untitled)';
    metaEl.textContent  = `${(s.language||'').toUpperCase()} · ${s.type} · ${Array.isArray(s.genres)?s.genres.join(', '):''}`;

    if (s.type === 'single'){
      const post = await getSinglePost(id).catch(()=>null);
      bodyEl.innerHTML = paras(post?.body||'');
      partsEl && (partsEl.innerHTML = '');
      navEl && (navEl.innerHTML = '');
    } else {
      // SERIES: list parts + render a selected part (or the first)
      const parts = await listSeriesPartsOrdered(id);
      if (!parts.length){ bodyEl.innerHTML = '<p class="muted">No parts yet.</p>'; return; }

      // sidebar/list of parts
      if (partsEl){
        partsEl.innerHTML = parts.map(p=>{
          const active = (Number(p.partNumber||0) === (partParam || Number(parts[0].partNumber||0)));
          return `<a class="pill ${active?'active':''}" href="${linkTo(id, p.partNumber)}">${esc(p.title || `Part ${p.partNumber}`)}</a>`;
        }).join(' ');
      }

      // pick current
      const current = parts.find(p=> Number(p.partNumber||0) === (partParam || Number(parts[0].partNumber||0))) || parts[0];
      bodyEl.innerHTML = paras(current?.body||'');

      // prev/next nav
      if (navEl){
        const { prev, next } = await getAdjacentParts(id, current.partNumber);
        navEl.innerHTML = `
          <div class="bar" style="justify-content:space-between; margin-top:16px">
            ${prev ? `<a class="ghost" href="${linkTo(id, prev.partNumber)}">← Previous</a>` : '<span></span>'}
            ${next ? `<a class="pill"  href="${linkTo(id, next.partNumber)}">Next →</a>` : '<span class="muted">End of series</span>'}
          </div>`;
      }
    }

    // bump hot score lightly when opened
    try{ await bumpHot(id, 1); }catch{}
  }

  load();
</script>
