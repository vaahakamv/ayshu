<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Panel · Vaahaka</title>
  <link rel="stylesheet" href="/ayshu/assets/app.css?v=6">
  <style>
    /* Preview overlay */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:999}
    .overlay.show{display:block}
    .overlay .sheet{
      position:relative; margin:4vh auto; max-width:900px; width:92%;
      background:#fff; border:1px solid var(--border); border-radius:20px;
      box-shadow:0 30px 80px rgba(20,12,0,.25); padding:18px;
      max-height:92vh; overflow:auto;
    }
    .overlay .close{position:sticky; top:-8px; float:right}
    .overlay .meta{color:var(--muted); margin-bottom:8px}
    .overlay .body{font-size:1.06rem; line-height:1.85}
    .overlay .body p{margin:0 0 1.05em}
    .overlay .body p + p{text-indent:1.1em}
    /* Hide auth until ready (prevents flicker) */
    #authSection[data-auth-ready="0"]{visibility:hidden;height:0;margin:0;padding:0;overflow:hidden}
  </style>
</head>
<body>

<header class="nav">
  <div class="wrap bar" style="justify-content:space-between;">
    <a href="/ayshu/" class="brand">Vaahaka</a>
    <nav class="bar">
      <a href="/ayshu/explore.html">Explore</a>
      <a href="/ayshu/write.html">Write</a>
      <a href="/ayshu/about.html">About</a>
      <a href="/ayshu/mypanel.html" aria-current="page">My Panel</a>
    </nav>
  </div>
</header>
<div id="toast" class="toast"></div>

<!-- Auth (flicker-free) -->
<div class="wrap section" id="authSection" data-auth-ready="0">
  <div id="authBar" class="card bar" style="display:flex; gap:8px;">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <button id="btnLogin">Login</button>
    <button id="btnSignup" class="ghost">Sign up</button>
    <button id="btnGoogle" class="ghost">Google</button>
  </div>
  <div id="userBar" class="card bar" style="display:none; justify-content:space-between;">
    <div id="who" class="muted"></div>
    <div class="bar"><button id="btnLogout" class="ghost">Logout</button></div>
  </div>
</div>
<script type="module">
  import { wireAuthBar } from "/ayshu/assets/firebase.js?v=113";
  wireAuthBar();
</script>

<!-- My submissions -->
<div class="wrap section">
  <h2>My Submissions</h2>
  <div id="mine" class="grid cards"></div>
</div>

<!-- Owner queue (only for owners) -->
<div class="wrap section" id="ownerSec" style="display:none">
  <h2>Owner Queue</h2>
  <div class="muted">Visible only to owners (nmmc@live.com, ayshuaysh@gmail.com).</div>
  <div id="queue" class="grid cards"></div>
</div>

<!-- Preview overlay -->
<div id="preview" class="overlay" aria-hidden="true">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="pvTitle">
    <button class="ghost close" id="closePreview">Close ✕</button>
    <h2 id="pvTitle" style="margin:0 0 6px"></h2>
    <div id="pvMeta" class="meta"></div>
    <div id="pvBody" class="body"></div>
  </div>
</div>

<script type="module">
  import {
    auth, getRole, listMyStories, listAllStories, getStory,
    getSinglePost, listSeriesParts, updateStatus, deleteStory, toast
  } from "/ayshu/assets/firebase.js?v=113";

  const ownerSec = document.getElementById('ownerSec');
  const mine     = document.getElementById('mine');
  const queue    = document.getElementById('queue');

  const pvWrap   = document.getElementById('preview');
  const pvTitle  = document.getElementById('pvTitle');
  const pvMeta   = document.getElementById('pvMeta');
  const pvBody   = document.getElementById('pvBody');
  const btnClose = document.getElementById('closePreview');

  const OWNER_EMAILS = new Set(["nmmc@live.com","ayshuaysh@gmail.com"]);
  const isOwnerEmail = (e)=> OWNER_EMAILS.has((e||"").toLowerCase());

  async function isOwner(){
    const u = auth.currentUser; if (!u) return false;
    if (isOwnerEmail(u.email)) return true;
    try { return (await getRole(u.uid)) === "owner"; } catch { return false; }
  }

  // Render paragraphs safely
  function renderParagraphs(text){
    if (!text) return "<p class='muted'>No content.</p>";
    const safe = text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    return safe.split(/\n{2,}/).map(p=>`<p>${p.replace(/\n/g,' ')}</p>`).join("");
  }

  // View overlay (owners + author can view any status; others N/A here)
  async function openPreview(storyId){
    const u = auth.currentUser;
    if (!u){ toast("Login required"); return; }

    let s = null;
    try { s = await getStory(storyId); } catch {}

    if (!s){
      pvTitle.textContent = "Unavailable";
      pvMeta.textContent  = "";
      pvBody.innerHTML    = "<p class='muted'>Cannot load this story.</p>";
      pvWrap.classList.add('show'); pvWrap.setAttribute('aria-hidden','false'); return;
    }

    const owner = await isOwner();
    const author = !!s.authorId && s.authorId === (u.uid||"");
    if (!(owner || author) && s.status !== "published"){
      pvTitle.textContent = "Unavailable";
      pvMeta.textContent  = "";
      pvBody.innerHTML    = "<p class='muted'>This story isn’t published yet.</p>";
      pvWrap.classList.add('show'); pvWrap.setAttribute('aria-hidden','false'); return;
    }

    pvTitle.textContent = s.title || "(untitled)";
    pvMeta.textContent  = `${(s.language||'').toUpperCase()} · ${s.type} · ${Array.isArray(s.genres)?s.genres.join(', '):''} · ${s.status}`;

    if (s.type === "single"){
      const post = await getSinglePost(storyId).catch(()=>null);
      pvBody.innerHTML = renderParagraphs(post?.body||"");
    } else {
      const parts = await listSeriesParts(storyId).catch(()=>[]);
      pvBody.innerHTML = parts.length
        ? parts.map((p,i)=>(
            `<h3 style="margin:10px 0">${p.title || 'Part ' + (p.partNumber || (i+1))}</h3>` +
            renderParagraphs(p.body||"")
          )).join("")
        : "<p class='muted'>No parts yet.</p>";
    }

    pvWrap.classList.add('show');
    pvWrap.setAttribute('aria-hidden','false');
  }

  function closePreview(){
    pvWrap.classList.remove('show');
    pvWrap.setAttribute('aria-hidden','true');
  }
  btnClose.onclick = closePreview;
  pvWrap.addEventListener('click', (e)=>{ if (e.target === pvWrap) closePreview(); });
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closePreview(); });

  // Card templates — single "View" action for everyone
  const cardMy = (s)=>`
    <div class="card">
      <div><b>${s.title || '(untitled)'}</b></div>
      <div class="muted">${(s.language||'').toUpperCase()} · ${s.type} · <b>${s.status}</b></div>
      <div class="bar" style="margin-top:8px">
        <button class="pill" data-preview="${s.id}">View</button>
      </div>
    </div>`;

  const cardOwner = (s)=>`
    <div class="card">
      <div><b>${s.title || '(untitled)'}</b></div>
      <div class="muted">${(s.language||'').toUpperCase()} · ${s.type} · <b>${s.status}</b></div>
      <div class="bar" style="margin-top:8px; flex-wrap:wrap">
        <button class="pill" data-preview="${s.id}">View</button>
        ${s.status === 'published'
          ? `<button data-act="unpublish" data-id="${s.id}" class="ghost">Unpublish</button>`
          : `<button data-act="publish" data-id="${s.id}">Publish</button>`}
        <button data-act="delete" data-id="${s.id}" class="ghost">Delete</button>
      </div>
    </div>`;

  async function load(){
    const u = auth.currentUser;
    if (!u){
      mine.innerHTML  = '<div class="muted">Log in to see your submissions.</div>';
      ownerSec.style.display = 'none';
      queue.innerHTML = '';
      return;
    }
    const my = await listMyStories(u.uid, 200).catch(()=>[]);
    mine.innerHTML = my.length ? my.map(cardMy).join('') : '<div class="muted">No submissions yet.</div>';

    if (await isOwner()){
      ownerSec.style.display = 'block';
      const all = await listAllStories(400).catch(()=>[]);
      const manageable = all.sort((a,b)=>(b?.createdAt?.seconds||0)-(a?.createdAt?.seconds||0));
      queue.innerHTML = manageable.length
        ? manageable.map(cardOwner).join('')
        : '<div class="muted">Nothing to moderate.</div>';
    } else {
      ownerSec.style.display = 'none';
      queue.innerHTML = '';
    }
  }

  window.addEventListener('firebase-auth-changed', load);
  load();

  // Owner actions
  queue.addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if (btn.dataset.preview){ openPreview(btn.dataset.preview); return; }
    const id  = btn.dataset.id, act = btn.dataset.act;
    try{
      if (act === 'publish')   await updateStatus(id,'published');
      if (act === 'unpublish') await updateStatus(id,'approved');
      if (act === 'delete' && confirm('Delete this story?')) await deleteStory(id);
      toast('Done'); await load();
    }catch(err){ console.error(err); toast(err?.message || 'Action failed'); }
  });

  // Author previews
  mine.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    if (btn.dataset.preview){ openPreview(btn.dataset.preview); }
  });
</script>

</body>
</html>
