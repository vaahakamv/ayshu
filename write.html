<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Write · Vaahaka</title>
  <link rel="stylesheet" href="/ayshu/assets/app.css?v=8">
  <style>
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:#fff;max-width:760px;width:92%;border-radius:14px;box-shadow:0 16px 48px rgba(0,0,0,.18)}
    .modal header{padding:16px 18px;border-bottom:1px solid #eee}
    .modal main{padding:16px 18px;max-height:60vh;overflow:auto}
    .modal footer{padding:12px 18px;border-top:1px solid #eee;display:flex;gap:8px;justify-content:flex-end;align-items:center}
    .modal small, .modal li{font-size:13px;line-height:1.6}
    .muted-sm{font-size:12px;color:#666}

    /* Auth flicker guard */
    #authSection[data-auth-ready="0"]{visibility:hidden;height:0;margin:0;padding:0;overflow:hidden}

    /* Disable look */
    .blocked{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
<header class="nav">
  <div class="wrap bar" style="justify-content:space-between;">
    <a href="/ayshu/" class="brand">Vaahaka</a>
    <nav class="bar">
      <a href="/ayshu/explore.html">Explore</a>
      <a href="/ayshu/write.html" aria-current="page">Write</a>
      <a href="/ayshu/about.html">About</a>
      <a href="/ayshu/mypanel.html">My Panel</a>
    </nav>
  </div>
</header>

<div id="toast" class="toast"></div>

<!-- Auth (shows only when logged out; no flicker) -->
<div class="wrap section" id="authSection" data-auth-ready="0">
  <div id="authBar" class="card bar" style="display:flex; gap:8px;">
    <input id="email" placeholder="Email">
    <input id="pass" type="password" placeholder="Password">
    <button id="btnLogin">Login</button>
    <button id="btnSignup" class="ghost">Sign up</button>
    <button id="btnGoogle" class="ghost">Google</button>
  </div>
  <div id="userBar" class="card bar" style="display:none; justify-content:space-between;">
    <div id="who" class="muted"></div>
    <div class="bar"><button id="btnLogout" class="ghost">Logout</button></div>
  </div>
</div>
<script type="module">
  import { wireAuthBar } from "/ayshu/assets/firebase.js?v=115";
  wireAuthBar();
</script>

<div class="wrap section" style="max-width:820px">
  <h2>New Story</h2>
  <p class="muted" style="margin:6px 0 16px">
    Write an original story. <b>Single</b> publishes as one piece. <b>Series</b> can be posted in weekly parts.
  </p>

  <div id="verifyNote" class="muted" style="margin:8px 0">
    You must be logged in and email verified to submit.
  </div>

  <div class="grid">
    <label>Type
      <select id="type">
        <option value="single" selected>Single</option>
        <option value="series">Series</option>
      </select>
    </label>

    <label>Language
      <select id="language">
        <option value="en" selected>English</option>
        <option value="dv">Dhivehi</option>
      </select>
    </label>

    <label>Title
      <input id="title" placeholder="Story title">
    </label>

    <label>Genres <span class="muted">(separate with comma)</span>
      <input id="genres" placeholder="Romance, Folklore">
    </label>

    <label>Tags <span class="muted">(separate with comma)</span>
      <input id="tags" placeholder="island, sea, mystery">
    </label>

    <!-- Shown only for Series: choose existing or start new -->
    <label id="seriesPicker" style="display:none">
      Existing series
      <select id="seriesSelect">
        <option value="__new__" selected>➕ Start a new series…</option>
      </select>
      <div class="muted-sm">Pick a series to add a new part, or start a new one.</div>
    </label>

    <!-- Shown only for Series -->
    <label id="partWrap" style="display:none">Part number
      <input id="partNumber" type="number" min="1" value="1" />
      <div class="muted-sm">Use the correct sequence (Part 1, Part 2…).</div>
    </label>

    <label>Body
      <span class="muted">
        For <b>Single</b>, paste the full story. For <b>Series</b>, this will be the text of the part above.
      </span>
      <textarea id="body" placeholder="Write your story..."></textarea>
    </label>

    <div class="bar" style="align-items:center;gap:10px">
      <button id="btnSubmit" class="blocked">Submit for review</button>
      <button id="btnClear" class="ghost">Clear</button>
      <button id="btnViewTerms" class="ghost">Submission terms</button>
      <span id="agreeStatus" class="muted-sm"></span>
    </div>
  </div>

  <p class="muted-sm" style="margin-top:6px">
    By submitting, you confirm this is your original work and you agree to Vaahaka’s submission terms.
  </p>
</div>

<!-- TERMS & GUIDELINES MODAL (one-time agree, single button) -->
<div id="termsModal" class="modal-backdrop">
  <div class="modal">
    <header><h3 style="margin:0">Submission Terms & Guidelines</h3></header>
    <main>
      <p class="muted-sm">Please read and agree once. You can view this again anytime from the Write page.</p>
      <ul>
        <li><b>Originality:</b> Submit only your own original writing. No plagiarism or AI-generated content presented as your own. Credit any quotes with permission.</li>
        <li><b>Languages:</b> Dhivehi and English are supported. Use one per story; no auto-translations.</li>
        <li><b>Genres & Tags:</b> Pick accurate genres and helpful tags so readers can find your work.</li>
        <li><b>Adult content:</b> Mark 18+ if applicable. Explicit illegal content is not allowed.</li>
        <li><b>Respect:</b> No hate speech, harassment, or targeted abuse.</li>
        <li><b>Series:</b> Keep parts in order. Use clear titles (e.g., “Title — Part 2”).</li>
        <li><b>Review & Moderation:</b> All submissions are reviewed. Editors may request edits or reject content that violates these terms.</li>
        <li><b>Publication:</b> “Published” pieces appear on Explore. Edits to published stories re-enter review.</li>
        <li><b>Copyright & Takedown:</b> You own the rights or have permission to publish. We respond to infringement claims.</li>
        <li><b>Penalties:</b> Proven plagiarism or repeated violations → removal/unpublish and account ban. Serious abuse may be reported.</li>
        <li><b>Privacy:</b> Don’t post private information about others without explicit permission.</li>
      </ul>
    </main>
    <footer>
      <button id="btnCancelTerms" class="ghost">Close</button>
      <button id="btnAgreeTerms" class="pill">I Agree & Continue</button>
    </footer>
  </div>
</div>

<!-- PAGE LOGIC (module!) -->
<script type="module">
  import {
    auth, toast,
    createStoryShell, createSinglePost, addSeriesPart,
    listAuthorSeries
  } from "/ayshu/assets/firebase.js?v=115";

  const $ = id => document.getElementById(id);
  const E = {
    type: $('type'),
    language: $('language'),
    title: $('title'),
    genres: $('genres'),
    tags: $('tags'),
    body: $('body'),
    // series
    seriesPicker: $('seriesPicker'),
    seriesSelect: $('seriesSelect'),
    partWrap: $('partWrap'),
    partNumber: $('partNumber'),
    // buttons + notes
    submit: $('btnSubmit'),
    clear: $('btnClear'),
    viewTerms: $('btnViewTerms'),
    note: $('verifyNote'),
    agreeStatus: $('agreeStatus'),
    // modal
    modal: $('termsModal'),
    cancelTerms: $('btnCancelTerms'),
    agreeTerms: $('btnAgreeTerms')
  };

  const TERMS_KEY = 'vaahaka_terms_v1_agreed';
  const getArr = (v) => (v || '').split(',').map(s => s.trim()).filter(Boolean);
  const isAgreed = () => localStorage.getItem(TERMS_KEY) === '1';
  const setAgreed = () => localStorage.setItem(TERMS_KEY, '1');

  function show(el, flag){ el.style.display = flag ? '' : 'none'; }

  async function loadAuthorSeries(){
    const u = auth.currentUser;
    if (!u) return;
    const list = await listAuthorSeries(u.uid).catch(()=>[]);
    E.seriesSelect.innerHTML = `<option value="__new__" selected>➕ Start a new series…</option>`;
    for (const s of list){
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.title || `(untitled) — ${s.id.slice(0,6)}`;
      E.seriesSelect.appendChild(opt);
    }
  }

  function updateUIState(){
    const u = auth.currentUser;
    if (E.note) E.note.style.display = (!u || !u.emailVerified) ? 'block' : 'none';

    const isSeries = (E.type.value === 'series');
    show(E.partWrap, isSeries);
    show(E.seriesPicker, isSeries);

    const canSubmit = !!u && u.emailVerified && isAgreed() && !!E.title.value.trim();
    E.submit.classList.toggle('blocked', !canSubmit);
    E.submit.disabled = !canSubmit;

    E.agreeStatus.textContent = isAgreed()
      ? 'Terms agreed ✓'
      : 'You must agree to the submission terms to submit.';
  }

  function openTerms(){ E.modal.style.display = 'flex'; }
  function closeTerms(){ E.modal.style.display = 'none'; }

  if (!isAgreed()) openTerms();

  E.viewTerms.onclick   = openTerms;
  E.cancelTerms.onclick = closeTerms;
  E.agreeTerms.onclick  = () => { setAgreed(); closeTerms(); updateUIState(); toast('Thanks — terms accepted.'); };

  E.clear.onclick = () => {
    E.title.value=''; E.genres.value=''; E.tags.value=''; E.body.value='';
    if (E.type.value === 'series') E.partNumber.value = '1';
    E.seriesSelect.value = '__new__';
    updateUIState();
  };

  E.type.addEventListener('change', async ()=>{
    updateUIState();
    if (E.type.value === 'series') await loadAuthorSeries();
  });
  ['input','change','keyup'].forEach(evt => E.title.addEventListener(evt, updateUIState));

  window.addEventListener('firebase-auth-changed', async ()=>{
    updateUIState();
    if (auth.currentUser && E.type.value === 'series') await loadAuthorSeries();
  });
  updateUIState();

  async function submit(){
    const u = auth.currentUser;
    if (!u){ toast('Log in first.'); return; }
    if (!u.emailVerified){ toast('Verify your email first.'); return; }
    if (!isAgreed()){ toast('Please agree to the submission terms.'); return; }
    if (!E.title.value.trim()){ toast('Title required'); return; }

    E.submit.disabled = true; E.submit.classList.add('blocked');
    try{
      const isSeries = (E.type.value === 'series');
      const chosen = isSeries ? E.seriesSelect.value : '__new__';
      let storyId;

      if (isSeries && chosen !== '__new__'){
        storyId = chosen;
        const pn = Math.max(1, parseInt(E.partNumber.value || '1', 10));
        const body = E.body.value.trim();
        if (body){
          await addSeriesPart({
            storyId, partNumber: pn,
            title: `${E.title.value.trim()} — Part ${pn}`,
            body
          });
        }
      } else {
        storyId = await createStoryShell({
          title: E.title.value.trim(),
          language: E.language.value,
          type: E.type.value,
          genres: getArr(E.genres.value),
          tags: getArr(E.tags.value),
          uid: u.uid
        });

        const body = E.body.value.trim();
        if (E.type.value === 'single' && body){
          await createSinglePost(storyId, body);
        } else if (isSeries && body){
          const pn = Math.max(1, parseInt(E.partNumber.value || '1', 10));
          await addSeriesPart({
            storyId, partNumber: pn,
            title: `${E.title.value.trim()} — Part ${pn}`,
            body
          });
        }
      }

      E.title.value=''; E.genres.value=''; E.tags.value=''; E.body.value='';
      if (E.type.value === 'series') E.partNumber.value = '1';
      E.seriesSelect.value = '__new__';
      toast('Submitted for review ✅');
      setTimeout(()=>location.href='/ayshu/mypanel.html', 900);
    }catch(e){
      console.error(e); toast(e?.message || 'Submit failed');
    }finally{
      E.submit.disabled = false; updateUIState();
    }
  }
  E.submit.addEventListener('click', submit);
</script>
</body>
</html>
